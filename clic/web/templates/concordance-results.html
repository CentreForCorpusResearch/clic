{% extends "layout/default.html" %}

{% block stylesheets %}
  {{ super() }}

  <link href="/js/thirdparty/DataTables1.10.0-beta.2/media/css/dataTables.bootstrap.css" rel="stylesheet">
  <link href="/js/thirdparty/pace-0.5.1/themes/pace-theme-loading-bar.css" rel="stylesheet"/>
{% endblock %}

{% block title %}
    Concordance Search {{ super() }}
{% endblock %}

{% block body %}
  <!-- Choose view -->
  <ul class="nav nav-pills pull-right skinny clearfix">
      <li class="active"><a href="#" id="kwicView">KWIC</a></li>
      <li><a href="#" id="plotView">Plot</a></li>
      <!--<li><a href="#" id="statsView">Statistics</a></li>-->
  </ul>

  <h2 class="with-pills">Concordance Results</h2>

  <div id="concordanceWrap">

      <p id="searchedFor"></p>

      <table width="100%" class="table table-striped table-hover dataTable no-footer uonDatatable"
             id="dataTableConcordance">
          <thead>
          <tr>
              <th></th>
              <th>Left</th>
              <th>Node</th>
              <th>Right</th>
              <th>Book</th>
              <th>Ch</th>
              <th>Par</th>
              <th>Sen</th>
              <th>In&nbsp;bk</th>
          </tr>
          </thead>
          <tbody id="resultsTbody"></tbody>
      </table>
  </div>

  <div id="plotWrap">
      <table class="table table-striped table-hover tablePlot uonDatatable" id="dataTablePlot">
          <thead>
          <tr>
              <th>Title</th>
              <th>Words</th>
              <th>Words within book</th>
          </tr>
          </thead>

          <tbody id="plotTbody"></tbody>

      </table>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script src='/js/thirdparty/pace-0.5.1/pace.min.js'></script>

  <script src="/js/thirdparty/DataTables1.10.0-beta.2/media/js/jquery.dataTables.min.js"></script>
  <script src="/js/thirdparty/DataTables1.10.0-beta.2/extensions/TableTools/js/dataTables.tableTools.min.js"></script>
  <!-- datatables bootstrap js (css is above) see http://next.datatables.net/manual/styling/bootstrap -->
  <script src="/js/thirdparty/DataTables1.10.0-beta.2/media/js/dataTables.bootstrap.js"></script>

  <script>
  $(function () {

      $('#dataTableConcordance tbody').on( 'click', 'tr', function () {
          window.location = $(this).data('url');
      } );

      $('#plotWrap').hide();

      // custom sort functions see http://www.datatables.net/release-datatables/examples/basic_init/multi_col_sort.html
      jQuery.fn.dataTableExt.oSort['string-case-asc'] = function (x, y) {
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
      };

      jQuery.fn.dataTableExt.oSort['string-case-desc'] = function (x, y) {
          return ((x < y) ? 1 : ((x > y) ? -1 : 0));
      };

      /* new sort on L1 */
      jQuery.fn.dataTableExt.oSort['string-L1-asc'] = function (x, y) {
          var xwords = x.split(' ');
          var ywords = y.split(' ');
          return ((xwords[xwords.length - 1].toLowerCase() < ywords[ywords.length - 1].toLowerCase()) ? -1 : ((xwords[xwords.length - 1].toLowerCase() > ywords[ywords.length - 1].toLowerCase()) ? 1 : 0));
      };

      jQuery.fn.dataTableExt.oSort['string-L1-desc'] = function (x, y) {
          var xwords = x.split(' ');
          var ywords = y.split(' ');
          return ((xwords[xwords.length - 1].toLowerCase() < ywords[ywords.length - 1].toLowerCase()) ? 1 : ((xwords[xwords.length - 1].toLowerCase() > ywords[ywords.length - 1].toLowerCase()) ? -1 : 0));
      };

      /* new sort on R1 */
      jQuery.fn.dataTableExt.oSort['string-R1-asc'] = function (x, y) {
          var xwords = x.split(' ');
          var ywords = y.split(' ');
          return ((xwords[0].toLowerCase() < ywords[0].toLowerCase()) ? -1 : ((xwords[0].toLowerCase() > ywords[0].toLowerCase()) ? 1 : 0));
      };

      jQuery.fn.dataTableExt.oSort['string-R1-desc'] = function (x, y) {
          var xwords = x.split(' ');
          var ywords = y.split(' ');
          return ((xwords[0].toLowerCase() < ywords[0].toLowerCase()) ? 1 : ((xwords[0].toLowerCase() > ywords[0].toLowerCase()) ? -1 : 0));
      };

      // CONCORDANCE VIEW
      // Get URL params
      var params = location.search;
      var host = window.location.hostname;
      var totalNumberOfHits = 0;

      var searchTerms = params.slice(params.indexOf("terms=") + 6);
      searchTerms = decodeURIComponent(searchTerms.slice(0, searchTerms.indexOf("&")).replace(/\+/g, ' '));

      var testIdxMod = params.slice(params.indexOf("testIdxMod=") + 11);

      var searchSpace = "";

      switch(testIdxMod) {
          case "quote":
              searchSpace = "quotes";
              break;

          case "non-quote":
              searchSpace = "non-quotes";
              break;

          case "longsus":
              searchSpace = "long suspensions";
              break;

          case "shortsus":
              searchSpace = "short suspensions";
              break;

          default:
              searchSpace = "whole text";
              break;
      }

      jsonUrl = '/api/concordances/' + params; 

      // Chapter Markers from Bookcounts JSON
      function processChapterMarkers(data) {
          chapterDataArray = [];
          for (var x = 0; x < data[1].length; x++) {

              // Per book chapter SVG shading
              var bookTitle = data[1][x][1];
              var chapters = data[1][x][3]; // chapter data
              var total = (data[1][x][2][0] / 1000);// <total words in book> / <length of SVG (constant) >

              var xVal = '';
              var wVal = '';
              var svg = '';

              for (var i = 1; i < chapters.length; i = i + 2) {
                  xVal = chapters[i] / total;
                  wVal = (chapters[i + 1] - chapters[i]) / total; //width
                  svg += '<rect x="' + xVal + '" y="0" width="' + wVal + '" height="27" fill="#bbb"/>';
              }

              chapterDataArray.push({
                  booktitle: bookTitle,
                  svgMarkup: svg
              });
          }

          return chapterDataArray;
      }

      // Load concordance data into page.
      function processConcordanceData(data, chapterDataArray) {
          totalNumberOfHits = data.concordances[0];

          // start timer
          var start = (new Date).getTime();

          var content = '';
          // loop out values
          for (var x = 1; x < data.concordances.length; x++) {
              var wordsLhs = '';
              var wordsRhs = '';
              var node = '';
              var chapterViewUrl = '/chapter/' + data.concordances[x][3][0] + '/' + data.concordances[x][3][2] + '/';

              content += '<tr class="clickable_row" data-url="' + chapterViewUrl + '">';
              // counter
              content += '<td>' + x + '</td>';
              // words left
              for (var s = 0; s < data.concordances[x][0].length; s++) {
                  wordsLhs += data.concordances[x][0][s] + ' ';
              }

              content += '<td class="left nowrap" align="right"><span>' + wordsLhs + '</span></td>';

              // node
              for (var s = 0; s < data.concordances[x][1].length; s++) {
                  node += data.concordances[x][1][s] + ' ';
              }
              content += '<td class="hilight">' + node + '</td>';

              // words right
              for (var s = 0; s < data.concordances[x][2].length; s++) {
                  wordsRhs += data.concordances[x][2][s] + ' ';
              }
              content += '<td class="right nowrap">' + wordsRhs + '</td>';
              //Book
              content += '<td class="book">' + data.concordances[x][3][1] + '</td>';
              // Chapter
              content += '<td>' + data.concordances[x][3][2] + '</td>';
              // Paragraph
              content += '<td>' + data.concordances[x][3][3] + '</td>';
              // Sentence
              content += '<td>' + data.concordances[x][3][4] + '</td>';
              // % In book
              var wordInBook = (data.concordances[x][4][2] / data.concordances[x][4][3]) * 100; // word in book / total word count
              var xVal = Math.round(wordInBook) / 2;
              content += '<td><svg width="50px" height="15px" xmlns="http://www.w3.org/2000/svg">' +
                      '<rect x="0" y="4" width="50" height="7" fill="#ccc"/>' +
                      '<line x1="' + xVal + '" x2="' + xVal + '" y1="0" y2="15" stroke="black" stroke-width="2px"/>' +
                      '</svg>';
              content += '</tr></td>';
          }

          $('#resultsTbody').html(content);

          $('#dataTableConcordance').dataTable({

              // counter on column0, recounts when filter see http://www.datatables.net/release-datatables/examples/api/counter_column.html
              "fnDrawCallback": function (oSettings) {

                  var that = this;

                  /* Need to redo the counters if filtered or sorted */
                  if (oSettings.bSorted || oSettings.bFiltered) {
                      this.$('td:first-child', {"filter": "applied"}).each(function (i) {
                          that.fnUpdate(i + 1, this.parentNode, 0, false, false);
                      });
                  }
              },
              "fnInfoCallback": function (oSettings, iStart, iEnd, iMax, iTotal, sPre) {
                if (iTotal > 0) {
                    return iStart + " to " + iEnd + " of " + totalNumberOfHits + " entries";
                }

                return "0 entries";
              },
              "bFilter": true,
              "bSort": true,
              "bPaginate": false,
              "aoColumnDefs": [
                  { "bSortable": false, "aTargets": [ 0, 8 ] },
                  { "bSearchable": false, "aTargets": [0, 4, 5, 6, 7, 8 ] },
                  // custom sort Left using L1; right using R1
                  { "sType": "string-L1", "aTargets": [ 1 ] },
                  { "sType": "string-R1", "aTargets": [ 3 ] }
              ],
              // change phrase on search box (as now limited to just concordance)
              "oLanguage": {
                  "sSearch": "Filter concordance:"
              },
              // duplicate controls iflp
              // plus add dataTools eg save
              "sDom": '<iTf>rt<if>',
              "oTableTools": {
                  "aButtons": [
                      "csv",
                      "print",
                      {
                          "sExtends": "text",
                          "sButtonText": "Toggle metadata",
                          "fnClick": function (nButton, oConfig, oFlash) {
                              // show hide columns
                              /* Get the DataTables object again - this is not a recreation, just a get of the object */
                              var oTable = $('#dataTableConcordance').dataTable();
                              // until have time to find a more elegant solution
                              var index;
                              var colsList = [5, 6, 7, 8];
                              for (index = 0; index < colsList.length; ++index) {
                                  var bVis = oTable.fnSettings().aoColumns[colsList[index]].bVisible;
                                  oTable.fnSetColumnVis(colsList[index], bVis ? false : true);
                              }
                          }
                      }
                  ],
                  "sSwfPath": "/js/thirdparty/DataTables1.10.0-beta.2/extensions/TableTools/swf/copy_csv_xls.swf"
              }
          });


          /* =========================
           * PLOT VIEW
           ========================= */

          // start timer
          var startPLot = (new Date).getTime();

          // Add unique book titles to array
          var uniqueBookTitles = [];
          for (var x = 1; x < data.concordances.length; x++) {
              var bookTitle = data.concordances[x][3][1];
              if (uniqueBookTitles.indexOf(bookTitle) < 0) {
                  uniqueBookTitles.push(bookTitle);
              }
          }
          uniqueBookTitles.sort();

          var plotContent = '';
          for (var i = 0; i < uniqueBookTitles.length; i++) {

              // loop out line values
              var lines = '';
              var lineCount = 0; // no of occurrences of word
              for (var x = 1; x < data.concordances.length; x++) {
                  // if this is the book title we want
                  if (data.concordances[x][3][1] == uniqueBookTitles[i]) {
                      // calculate line values
                      var totalWordCountInBook = data.concordances[x][4][3];
                      var adjustedTotalWordCountInBook = totalWordCountInBook / 1000;
                      var wordInBook = data.concordances[x][4][2];
                      var xVal = wordInBook / adjustedTotalWordCountInBook;

                      // line here
                      lines += '<line x1="' + xVal + '" x2="' + xVal + '" y1="0" y2="27" stroke="#468847" stroke-width="3px"/>';
                      lineCount++;
                  }

              }
              plotContent += '<tr>';
              plotContent += '<td class="book">' + uniqueBookTitles[i] + '</td><td>'+lineCount+'</td>';
              plotContent += '<td class="plot">';
              plotContent += '<svg width="100%" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 27" preserveAspectRatio="none">';

              plotContent += '<rect x="0" y="0" width="1000" height="27" fill="#ccc"/>';

              // Add chapter shading to SVG
              var thisSvgMarkup = $.grep(chapterDataArray, function (e) { return e.booktitle == uniqueBookTitles[i]; }); // lookup
              if (typeof thisSvgMarkup[0] != "undefined") {
                  plotContent += thisSvgMarkup[0].svgMarkup;
              }
              plotContent += lines + '</svg></td></tr>';
          }

          $('#plotTbody').html(plotContent);
      }

      $.when(
          $.ajax({
              url: '/exampleJson/bookcounts.json',
              type: 'GET',
              dataType: 'json'}),
          $.ajax({
              url: jsonUrl,
              type: 'GET',
              dataType: 'json'})
      ).then(
          function(chaptersData, concordancesData) { // success
              chData = chaptersData[0];
              coData = concordancesData[0];

              chapterDataArray = processChapterMarkers(chData);
              processConcordanceData(coData, chapterDataArray);

              Pace.stop();
          },
          function(e) { // failure
              console.log(e);
              alert("Sorry. Failed to load data. Please try again.");
              Pace.stop()
          }
      );

      $("#searchedFor").html("Searched for <b>" + searchTerms + "</b> within <b>" + searchSpace + "</b>.");

      // SWITCH VIEWS
      $('#kwicView').click(function () {
          // to do - do this with show hide divs
          $(this).parent().addClass('active').siblings().removeClass('active');
          $('#plotWrap').hide();
          $('#concordanceWrap').show();
      });

      $('#plotView').click(function () {
          $(this).parent().addClass('active').siblings().removeClass('active');
          $('#concordanceWrap').hide();
          $('#plotWrap').show();

      });
  })
  ;
  </script>
{% endblock %}